## 알림 시스템 설계

##### 1단계, 문제 이해 및 설계 범위 확정
질문을 통한 설계 범위 확정

Q) 어떤 종류의 알림 ?
* 푸시 알림, SMS 메시지, 이메일
* iOS, Android, Laptop/Desktop 지원해야 함

Q) 실시간 시스템인지?
* 연성 실시간 시스템 (Soft real-time)
* 가능한 빨리 전달되어야 하지만, 요청이 몰린 경우 약간의 딜레이 허용

Q) 사용자가 알림을 받지 않는 옵션이 존재하는지?
* 사용자가 알림을 허용하지 않으면 알림을 받지 않음

Q) 하루에 몇 건의 알림?
* 천만 건의 모바일 푸시
* 백만 건의 SMS 메시지
* 5백만 건의 이메일

##### 2단계, 개략적 설계안 제시 및 동의 구하기

###### 알림 유형별 지원 방안
###### iOS 푸시 알림

* 알림 제공자 → APNS → iOS 단말기

* 알림 제공자
  * 알림 요청을 만들어 APNS로 보내는 주체
  * 단말토큰, 페이로드 데이터 필요
* APNS: 애플이 제공하는 원격 서비스, 푸시 알림을 iOS 단말로 보냄

###### 안드로이드
* 알림 제공자 → FCM (Firebase Cloud Messaging) → 안드로이드 단말
###### SMS 메시지
* 알림 제공자 → SMS 서비스 (네이버, NHN, 가비아 등) → SMS 수신 단말
###### 이메일
* 알림 제공자 → 이메일 서비스 (Sendgrid, Mailchimp, 네이버, 구글 등) → 이메일 수신 단말

###### 연락처 정보 수집 절차
알림을 보내려면 모바일 단말 토큰, 전화번호, 이메일 주소 등의 정보가 필요하다. 즉, 앱을 설치한 후에 처음 계정에 가입할 때 해당 사용자의 정보를 데이터베이스에 저장한다.

###### 개략적 설계안 (초안)
* 1부터 N까지의 서비스: 이 서비스 각각은 마이크로서비스일수도 있고, 크론잡일 수도 있고, 분산 시스템 컴포넌트일 수도 있다.
* 알림 시스템: 알림 시스템은 알림 전송/수신 처리의 핵심이다. 이 시스템은 서비스 1~N에 알림 전송을 위한 API를 제공해야 하고, 제 3자 서비스에 전달할 알림 페이로드를 만들어 낼 수 있어야 한다. (알림 서버의 역할이라고 생각)
* 제3자 서비스: 이 서비스들은 사용자에게 알림을 실제로 전달하는 역할을 한다. 제 3자 서비스와의 통합을 진행할 때 유의할 것은 확장성이다. 쉽게 새로운 서비스를 통합하거나 기존 서비스를 제거할 수 있어야 한다는 뜻이다.

###### 개략적 설계안 (초안)의 문제점
* SPOF(Single-Point-Of-Failure): 알림 서비스에 서버가 하나밖에 없다는 것은, 그 서버에 장애가 생기면 전체 서비스의 장애로 이어진다는 뜻이다.
* 규모 확장성: 한 대 서비스로 푸시 알림에 관계된 모든 것을 처리하므로, 데이터베이스나 캐시 등 중요 컴포넌트의 규모를 개별적으로 늘릴 방법이 없다.
* 성능 병목: 알림을 처리하고 보내는 것은 자원을 많이 필요로 하는 작업일 수 있다. 모든 것을 한 서버로 처리하면 사용자 트래픽이 많이 몰리는 시간에는 시스템이 과부하 상태에 빠질 수 있다.

###### 개선된 설계안
* 데이터베이스와 캐시를 알림 시스템의 주 서버에서 분리한다.
* 알림 서버를 증성하고 자동으로 수평적 규모 확장이 이루어질 수 있도록 한다.
* 메세지 큐를 이용해 시스템 컴포넌트 사이의 강한 결합을 끊는다.

##### 3단계, 상세 설계
###### 데이터 손실 방지
* 알림 시스템은 알림 데이터를 DB에 보관하고 재시도 메커니즘을 구현해야 함.
* 알림 로그를 DB에 유지하는 것도 하나의 방법 → 이를 사용하여 재시도 메커니즘?
###### 재시도 방지
* 작업 서버에 보내야 할 알림이 도착하면 이벤트 ID를 검사하여 이전에 보낸 적이 있는지 확인
  * 알림 로그를 사용
  * 계속해서 DB/Cache query? ⇒ 1차적으로 Bloom filter를 이용해 query 전 확인?
###### 알림 설정
* 사용자가 알림 설정으 상세히 조절할 수 있도록 알림 설정 테이블 을 이용.
* 알림 수단마다 허용 여부를 확인 → 알림 보내기 전 필터링 필요
###### 재시도 방법
* 제 3자 서비스가 알림 전송 실패하면, 재시도 전용 큐에 넣어 알림 재시도
* 같은 문제가 발생하면 개발자에게 알림(alert)
  * 재시도 전용 큐에 넣을 때, retry 횟수도 넣어야 될 듯?
###### 큐 모니터링
* MQ가 중추적인 역할을 하다보니, 모니터링 필요.
* 쌓인 알림의 개수를 보면서 처리가 잘 되고 있는지 확인.




